---
layout: post
section-type: post
title: iOS AdHoc Signing && Distribution via Public Website(Node.js,Bluemix)
category: tech
tags: [ 'tutorial' ]
---
## é¡¹ç›®ç®€ä»‹

ç§»åŠ¨ç«¯è¶Šæ¥è¶Šç«çš„ä»Šå¤©ï¼Œæˆ‘çš„è®¸å¤šå°ä¼™ä¼´ä¹Ÿçº·çº·ä»J2EEçš„å‘é‡Œè·³å‡ºæ¥æŠ•èº«iOSå’ŒAndroidçš„æ¸©æš–æ€€æŠ±ã€‚ä¸€è·¯ä¸Šå°ä¼™ä¼´ä»¬ä¹Ÿè¸©äº†å¾ˆå¤šå‘ï¼ŒåŸ‹äº†å¾ˆå¤šé›·.åœ¨è¿™ä¹‹ä¸­ï¼Œåº”ç”¨å‘å¸ƒé—®é¢˜çš„å‘ç‰¹åˆ«å¤šï¼Œå¾ˆå¤šæ–°äººéƒ½ä¼šè¿·å¤±åœ¨è¿™ç‚¹ã€‚å°¤å…¶æ˜¯åœ¨iOSå¹³å°ï¼Œç›¸æ¯”äºå®‰å“ï¼Œç”±äºè‹¹æœçš„ä¸¥æ ¼ç®¡æ§å¯¼è‡´iOS Appçš„å‘å¸ƒå˜æˆä¸€ä¸ªå¾ˆéº»çƒ¦çš„äº‹æƒ…ã€‚æ¯”å¦‚ä½ å¼€å‘äº†ä¸€ä¸ªæœ‰è¶£çš„iOSé—¹é’Ÿåº”ç”¨ï¼Œæƒ³ç»™ä½ çš„æœ‹å‹ğŸ» åŒå­¦å®‰è£…ç§€ä¸€å‘ã€‚ ä½ å¯ä»¥é€‰æ‹©å¦‚ä¸‹å››ç§æ–¹æ³•æ¥ç»™ä»–è£…:


å‘å¸ƒæ–¹æ³•                | è¯„ä»·
----------------------------|-----------------------------
 æŠ±ç€ä½ çš„Macï¼Œå¸¦ç€æ•°æ®çº¿å»æ•²ä»–å®¶é—¨        | æˆ‘å°±ä¸å¤šåŠ èµ˜è¿°ï¼Œå¦‚æœğŸ» åŒå­¦æ˜¯ä¸ªç¾ä¸½çš„å¦¹å­ï¼Œè¯·ç›´æ¥é‡‡ç”¨ã€‚
ä½¿ç”¨å®˜æ–¹çš„Appstore | AppStoreé€šå¸¸æ¥è¯´éƒ½è¦ç»è¿‡ä¸€ä¸ªæ¼«é•¿çš„å®¡æ ¸æœŸï¼Œå³ä½¿è‹¹æœå·²ç»å°½é‡[è®©è¿™ä¸ªè¿‡ç¨‹æ— ç—›äº†](http://www.feng.com/iPhone/news/2016-05-11/App-Store-application-review-time-is-less-than-24-hours_646453.shtml)ã€‚ä½†æ˜¯ä¾ç„¶è¦ä¸€å¤©å·¦å³çš„æ—¶é—´ï¼ŒåŒæ—¶è¿˜ä¸ä¿è¯ä¸€æ¬¡å°±èƒ½é€šè¿‡ï¼Œå¯¹è‡ªå·±ä»£ç åŠå…¶è‡ªä¿¡è€Œä¸”æœ‰è€å¿ƒçš„åŒå­¦å¯ä»¥é‡‡ç”¨ã€‚
ä½¿ç”¨TestFlightçš„æµ‹è¯•åŠŸèƒ½ | å®˜æ–¹æ¨èçš„æµ‹è¯•æ–¹æ³•,åˆ†ä¸ºå†…éƒ¨æµ‹è¯•å’Œå¤–éƒ¨æµ‹è¯•ä¸¤ç§ã€‚ å¤–éƒ¨æµ‹è¯•å’Œç¬¬äºŒç§æ–¹æ³•ä¸€æ ·ï¼Œéœ€è¦ä¸€å¤©å·¦å³çš„å®¡æ ¸æœŸã€‚ å†…éƒ¨æµ‹è¯•çš„è¯ï¼Œåªéœ€è¦ä¸€å°é‚®ä»¶ç¡®è®¤ï¼ˆPS--è¿™ä¸ªç»å¸¸ä¼šè¢«è‡ªåŠ¨å½’ç±»åˆ°åƒåœ¾é‚®ä»¶ï¼‰ï¼Œå°±å¯ä»¥å¾—åˆ°ä¸‹è½½é“¾æ¥ï¼Œä¸è¿‡æœ‰ä¸€ä¸ªæœ€å¤š25ä¸ªäººçš„é™åˆ¶ã€‚å¦‚æœä½ éœ€è¦ç§€ä¸€è„¸çš„åŒå­¦ä¸å¤šï¼Œå¯ä»¥é€‰æ‹©è¿™ä¸ªæ¨¡å¼ã€‚ å…·ä½“æµç¨‹[æˆ³è¿™é‡Œ](https://blog.coding.net/blog/ios-testFlight)
ä½¿ç”¨AdHocçš„æ–¹å¼å¯¼å‡ºipaæ–‡ä»¶ç»™ä»–è£… | æˆ‘æ¥ä¸‹æ¥è¦ä»‹ç»å®ç°çš„æ–¹æ³•ï¼Œ å¥¹å¯¹æ‹¥æœ‰Enterprise Certificateçš„äººç‰¹åˆ«å‹å¥½ã€‚ é€šè¿‡è¿™ç§æ–¹æ³•ï¼Œæ²¡æœ‰äººæ•°é™åˆ¶ï¼Œæ²¡æœ‰å®¡æ ¸æ—¶é—´ï¼Œå¯ä»¥é€šè¿‡è®¿é—®ç½‘ç«™ç›´æ¥å®‰è£…åˆ°ğŸ» åŒå­¦çš„æ‰‹æœºä¸Šã€‚ å¦‚æœä½ æ²¡æœ‰Enterprise Certificateï¼Œ ä½ éœ€è¦æ”¶é›†å°ä¼™ä¼´ä»¬æ‰‹æœºæˆ–è€…iPadçš„UDIDï¼Œå…·ä½“æ–¹æ³•[æˆ³è¿™é‡Œ](http://www.iclarified.com/52179/how-to-find-your-iphones-udid)

### Pre Step

å¯¹äºæ²¡æœ‰Enterprise Certificateçš„åŒå­¦ï¼Œè¯·å…ˆè·Ÿç€è¿™ä¸€æ­¥åˆå§‹åŒ–ä½ çš„provision profileã€‚ç”¨Enterprise Certificateçš„åŒå­¦ä¼šç¨æœ‰ä¸åŒã€‚åœ¨IBMï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªè‡ªåŠ¨build + signingçš„ç³»ç»Ÿï¼Œåªéœ€è¦æäº¤xcodeé¡¹ç›®ï¼Œä¼šç›´æ¥ç”Ÿæˆä¸€ä¸ªç”¨Enterprise Certç­¾åå¥½çš„ipaæ–‡ä»¶ã€‚ å¦‚æœä½ æœ‰ç›´æ¥ä½¿ç”¨Enterprise Certçš„æƒé™å¯ä»¥ç›´æ¥è·³åˆ°Step1

é¦–å…ˆä½ è¦æœ‰ä¸€ä¸ªå¼€å‘è€…è´¦æˆ·ï¼Œå¦‚æœæ²¡æœ‰[å‡ºé—¨å·¦è½¬](https://developer.apple.com/programs/enroll/)

ç™»å½•è¿›ä½ çš„å¼€å‘è€…è´¦æˆ·ï¼Œä¼šçœ‹åˆ°å¦‚ä¸‹é¡µé¢ï¼Œ æˆ‘ä»¬è¿™é‡Œå‡å®šä½ çš„Macæœ‰signningçš„certificateï¼Œå¦‚æœæ²¡æœ‰è¯·[æˆ³è¿™é‡Œ](https://developer.apple.com/library/content/documentation/IDEs/Conceptual/AppDistributionGuide/MaintainingCertificates/MaintainingCertificates.html). è¿™ä¸ªæ˜¯ä¿è¯ä½ çš„ç”µè„‘æœ‰ç»™ipaç­¾åçš„æƒåŠ›

![image](https://s30.postimg.org/d4q1msh3l/Screen_Shot_2016_12_14_at_7_46_08_PM.png)

æ¥ä¸‹æ¥è¦è¿›è¡Œä¸‰ä¸ªåŠ¨ä½œ

1. åœ¨å·¦ä¾§menuçš„Device -> Allé‡Œé¢åŠ å…¥ä½ æ”¶é›†åˆ°çš„UDID
2. åœ¨å·¦ä¾§menuçš„Identifier -> App IDsé‡Œé¢åŠ å…¥ä½ æƒ³buildçš„appçš„ bundle ID (è¿™ä¸ªå¾ˆå…³é”®)
3. åœ¨å·¦ä¾§menuçš„Provisions Profiles -> Allé‡Œé¢æ–°å»ºä¸€ä¸ªè·Ÿä½ çš„APP IDç»‘å®šçš„AdHoc Distributionçš„profile,è¿™é‡Œä¼šè®©ä½ é€‰æ‹©certificateæ¥ç¡®ä¿ä¸ä¼šè¢«ç›—ç”¨

ä¸‹è½½è¿™ä¸ªprofileï¼Œä½ ä¼šå¾—åˆ°ä¸€ä¸ªmobileprovisionæ–‡ä»¶ï¼Œæš‚æ—¶å¤§åŠŸå‘Šæˆï¼Œä½ å¾—åˆ°äº†ä¸€ä¸ªå¯ä»¥ç»™Appç­¾åçš„æ–‡ä»¶,åŒå‡»å®‰è£…è¿™ä¸ªæ–‡ä»¶


### Step 1 - ç­¾åipaæ–‡ä»¶


è¿™é‡Œæˆ‘ä»¬ä»¥Xcode Version 8.2 (8C38)ä¸ºä¾‹ï¼Œç»è¿‡ä¸Šä¸€æ­¥çš„mobileprovisionæ–‡ä»¶çš„å®‰è£…ï¼Œåœ¨ä¸‹å›¾çš„æ‰€ç¤ºçš„ä½ç½®å¯ä»¥æŸ¥çœ‹åˆ°General -> Signing -> Team -> Add Account -> View Details

![image](https://s23.postimg.org/hs9njzn6z/Screen_Shot_2016_12_14_at_8_16_52_PM.png)

ä¹Ÿå¯ä»¥åœ¨ General -> Signing -> ProvisionING Profileé‡Œç›´æ¥æŸ¥çœ‹

![image](https://s29.postimg.org/h0y3btko7/Screen_Shot_2016_12_14_at_8_21_06_PM.png)

æ¥ä¸‹æ¥Product -> Archive

![image](https://s27.postimg.org/tvwccxhvn/Screen_Shot_2016_12_14_at_8_24_23_PM.png)

ç„¶åé€‰æ‹©export -> Save for Ad Hoc Deploymentï¼Œ æœ‰Enterprise Certçš„åŒå­¦é€‰æ‹© export -> Save for Enterprise Deployment

![image](https://s24.postimg.org/3rozz9m2d/Screen_Shot_2016_12_14_at_8_27_37_PM.png)

ç„¶åä¸€è·¯nextä¸‹å», è®°å¾—é€‰ä¸Šgenerate mainfest.plist,è€Œä¸”ä¸è¦é€‰ rebuild from bitcode, ä¸ç„¶ä¼šå¾ˆæ…¢

![image](https://s26.postimg.org/dd7fprnwp/Screen_Shot_2016_12_15_at_5_04_24_PM.png)

åœ¨ä¸‹ä¸€æ­¥é‡Œå¡«ä¸Šwebsiteçš„åœ°å€å’Œlogoåœ°å€ï¼Œå¡«é”™ä¹Ÿæ²¡å…³ç³»ç­‰ä¸‹å¯ä»¥æ‰‹åŠ¨æ”¹æ–‡ä»¶ã€‚

![image](https://s26.postimg.org/oqtz0yyfd/Screen_Shot_2016_12_15_at_5_25_12_PM.png)

Archiveä¹‹åä½ ä¼šå¾—åˆ°ä¸€ä¸ªipaå’Œä¸€ä¸ªmainfest.plistæ–‡ä»¶

### Step 2 - Distributionç½‘ç«™å¼€å‘

è¿™ä¸€æ­¥æˆ‘ä»¬å°±è¦å¼€å§‹å¼€å‘æˆ‘ä»¬çš„ç½‘ç«™,Sample Codeåœ¨[è¿™é‡Œ](https://github.com/YouYue123/iOS-Adhoc-Distribution)

è¿™æ˜¯ç½‘ç«™çš„ç»“æ„å’Œå¯¹å„ä¸ªç›¸å…³æ–‡ä»¶çš„è¯´æ˜
![image](https://s26.postimg.org/lnxubc8uh/Screen_Shot_2016_12_15_at_5_55_11_PM.png)

æ–‡ä»¶ | è¯´æ˜
----------------------------|-----------------------------
app/ | ç”¨æ¥æ”¾åˆšåˆšç”Ÿæˆçš„ipaå’Œmainfest.plistæ–‡ä»¶
node_modules/ | node libraryæ–‡ä»¶
public/ | ç½‘ç«™ç›¸å…³é™æ€æ–‡ä»¶
app.js | web server ä¸»å…¥å£

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹app.js
```
'use strict';
const express = require('express')
const fileSystem = require('fs')
const path = require('path')
const cfenv = require('cfenv')
const app = express()
//set public as the static resource
app.use(express.static(__dirname + '/public'))
//set plist and ipa path
const appPath = '/app/'+ process.env.npm_package_config_appName +'.ipa'
const plistFilePath = path.join(__dirname, '/app/manifest.plist')
const ipaFilePath = path.join(__dirname, appPath)
//response to download action
app.get('/app/download_app',function(req,res){
	  res.set('Content-Type', 'text/xml plist')
	  res.sendFile(plistFilePath)
})
//transfer app stream
app.get(appPath,function(req,res){
		res.set('Content-Type','application/octet-stream ipa')
		res.sendFile(ipaFilePath)
})
// get the app environment from Cloud Foundry
var appEnv = cfenv.getAppEnv()
// start server on the specified port and binding host
app.listen(appEnv.port, '0.0.0.0', function() {
	// print a message when the server starts listening
  console.log("server starting on " + appEnv.url);
})

```

### Step 3 - ç½‘ç«™éƒ¨ç½²åˆ°Bluemix
